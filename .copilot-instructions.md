# Copilot Instructions for JIRA Automation Toolkit

This codebase provides automated login and API interaction with TMForum JIRA (https://projects.tmforum.org/jira/) using Playwright for authentication and the JIRA REST API for data retrieval.

## üéØ Project Purpose

**Primary Goal**: Automate JIRA authentication and provide a Python toolkit for querying issues, particularly from the "AP" project within the last month.

**Key Features**:
- Automated browser login with cookie capture
- Session management and reuse
- JIRA REST API client with JQL support
- Corporate proxy support for enterprise environments
- Robust error handling and debugging tools

## üìÅ File Structure & Responsibilities

### Core Files

- **`login.py`**: `JiraLoginBot` class - Handles Playwright-based authentication
- **`jira_api.py`**: `JiraApiClient` class - JIRA REST API operations
- **`example.py`**: Complete usage demonstration and testing
- **`debug_auth.py`**: Step-by-step authentication debugging tool

### Configuration Files

- **`.env`**: Environment variables (credentials, proxy settings)
- **`requirements.txt`**: Python dependencies (Playwright, requests, python-dotenv)
- **`jira_cookies.json`**: Cached authentication cookies (auto-generated)

### Setup & Documentation

- **`setup.bat`** / **`setup.sh`**: Environment setup scripts
- **`README.md`**: Basic project documentation
- **`API_README.md`**: Comprehensive API usage guide

## üîß Key Components

### Authentication Flow
1. **Cache Check**: Look for existing valid cookies
2. **File Load**: Load saved cookies from `jira_cookies.json`
3. **Fresh Login**: Playwright automation if needed
4. **Cookie Storage**: Save session cookies for reuse

### JIRA API Integration
- **Authentication**: Uses captured cookies for API requests
- **JQL Queries**: Support for JIRA Query Language
- **Project-Specific Methods**: Pre-built queries for AP project
- **Error Handling**: Automatic retry on 401 errors

## üåê Corporate Environment Configuration

### Proxy Settings
The codebase is designed for Vodafone's corporate network:
- **Default Proxy**: `http://proxy-nby.gslb.internal.vodafone.co.uk:8080`
- **Configuration**: Set via `.env` file (`HTTP_PROXY`, `HTTPS_PROXY`)
- **Automatic Detection**: Both Playwright and requests use proxy settings

### Network Considerations
- **pip Configuration**: `setup.bat` creates `%APPDATA%\pip\pip.ini` for proxy
- **SSL Handling**: Trusted hosts configured for PyPI access
- **Corporate Firewall**: All components designed to work behind corporate proxy

## üîê Security & Credentials

### Environment Variables (.env)
```bash
# Required
JIRA_USERNAME=stephen.harrop@vodafone.com
JIRA_PASSWORD=Tim1tmfpwd!

# Optional (can be commented out when not needed)
HTTP_PROXY=http://proxy-nby.gslb.internal.vodafone.co.uk:8080
HTTPS_PROXY=http://proxy-nby.gslb.internal.vodafone.co.uk:8080
```

### Cookie Management
- **Storage**: `jira_cookies.json` (DO NOT commit to version control)
- **Expiration**: Automatic detection and refresh
- **Security**: Contains sensitive session tokens

## üíª Usage Patterns

### Quick Start
```python
from jira_api import JiraApiClient

async def main():
    client = JiraApiClient()
    if await client.authenticate():
        issues = client.get_ap_issues_last_month()
        for issue in issues:
            print(f"{issue['key']}: {issue['summary']}")
```

### Advanced JQL Queries
```python
# Custom search
jql = 'project = "AP" AND status = "In Progress" AND updated >= -7d'
results = client.search_issues(jql, max_results=100)

# Pagination handling
all_issues = []
start_at = 0
while True:
    batch = client.search_issues(jql, max_results=50, start_at=start_at)
    if not batch['issues']:
        break
    all_issues.extend(batch['issues'])
    start_at += 50
```

## üêõ Debugging & Troubleshooting

### Debug Tools
- **`debug_auth.py`**: Step-by-step authentication testing
- **Browser Mode**: Set `headless=False` in `JiraLoginBot` for visual debugging
- **Screenshots**: Auto-captured on login failures (`login_error.png`)

### Common Issues & Solutions

1. **Authentication Failures**
   - Check credentials in `.env`
   - Verify proxy settings if behind firewall
   - Run `debug_auth.py` for detailed testing

2. **API 401 Errors**
   - Cookies may have expired - use `force_refresh=True`
   - Check XSRF token handling
   - Verify project permissions

3. **Network Issues**
   - Confirm proxy configuration
   - Check corporate firewall settings
   - Verify TMForum JIRA accessibility

## üé® TMForum JIRA Specifics

### Login Process
- **URL**: `https://projects.tmforum.org/jira/`
- **Login Pattern**: Click `#user-options > a.login-link` ‚Üí Fill form ‚Üí Submit `#btnSubmit`
- **Cookie Consent**: Handles Cookiebot popup (`#CybotCookiebotDialogBodyLevelButtonLevelOptinAllowAll`)

### Authentication Cookies
- **JSESSIONID**: Primary session identifier
- **atlassian.xsrf.token**: CSRF protection token
- **seraph.rememberme.cookie**: Persistent login
- **tmf_hub** / **tmfidp**: TMForum-specific identity tokens

### API Endpoints
- **Base**: `https://projects.tmforum.org/jira/rest/api/2/`
- **User Info**: `/myself`
- **Search**: `/search?jql=...`
- **Project**: `/project/{projectKey}`

## üìù Development Guidelines

### Code Style
- **Type Hints**: Use comprehensive typing annotations
- **Error Handling**: Wrap API calls in try/catch with meaningful messages
- **Logging**: Use print statements with emoji prefixes for user feedback
- **Async/Await**: Maintain async patterns for Playwright operations

### Adding New Features
1. **Authentication First**: Always ensure `await client.authenticate()` is called
2. **Error Recovery**: Handle 401 errors with automatic refresh
3. **Proxy Support**: Use session.proxies for all HTTP requests
4. **Cookie Management**: Leverage existing cookie infrastructure

### Testing Workflow
1. **Debug Script**: Run `debug_auth.py` to verify authentication
2. **Example Script**: Run `example.py` to test full workflow
3. **Manual Testing**: Set `headless=False` for visual verification

## üîÑ Maintenance Tasks

### Regular Updates
- **Cookie Refresh**: Cookies expire; system handles automatic refresh
- **Dependency Updates**: Monitor Playwright and requests versions
- **Proxy Changes**: Update `.env` if corporate proxy changes

### Monitoring
- **Authentication Success**: Monitor 401 error rates
- **API Reliability**: Track JIRA API response times
- **Cookie Lifespan**: Observe session expiration patterns

## üöÄ Future Enhancements

### Potential Improvements
1. **Multi-Project Support**: Extend beyond AP project
2. **Caching Layer**: Redis/database for session management
3. **Webhook Integration**: Real-time JIRA updates
4. **Report Generation**: Automated issue reports
5. **Dashboard**: Web interface for issue visualization

### API Expansion
- **Issue Creation**: POST operations for new issues
- **Bulk Operations**: Batch updates and transitions
- **Attachment Handling**: File upload/download capabilities
- **Comment Management**: Add/retrieve issue comments

## üìã Dependencies & Versions

### Python Packages
- **playwright==1.40.0**: Browser automation
- **python-dotenv==1.0.0**: Environment variable management
- **requests==2.31.0**: HTTP client for API calls

### Browser Requirements
- **Chromium**: Installed via `playwright install chromium`
- **Corporate Compatibility**: Works with enterprise proxy configurations

## üè¢ Corporate Integration Notes

### Vodafone-Specific Configuration
- **Proxy Server**: `proxy-nby.gslb.internal.vodafone.co.uk:8080`
- **Domain Authentication**: Uses Vodafone email addresses
- **Network Security**: Designed for corporate firewall environment

### Compliance Considerations
- **Access Logging**: All API calls are logged by JIRA
- **Credential Security**: Uses environment variables, not hardcoded secrets
- **Automation Policy**: Ensure compliance with corporate automation policies

---

## üéØ Quick Reference for Copilot

When working with this codebase:

1. **Always check authentication first** - Most issues stem from expired cookies
2. **Use the debug script** - `debug_auth.py` is your best friend for troubleshooting
3. **Respect the async pattern** - Playwright operations require async/await
4. **Handle proxy configuration** - Corporate network requires special handling
5. **Monitor cookie expiration** - Implement auto-refresh patterns
6. **Test incrementally** - Use `headless=False` for visual debugging
7. **Check TMForum specifics** - Login selectors and API endpoints are site-specific
8. **Maintain security** - Never commit `.env` or `jira_cookies.json`

This toolkit provides a robust foundation for JIRA automation within corporate environments, with particular attention to authentication challenges and proxy configurations.